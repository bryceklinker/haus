@using Haus.Core.Models
@using Haus.Core.Models.Health
@using Haus.Site.Host.Shared.Realtime
@using Microsoft.Extensions.Logging

@implements IAsyncDisposable

@inject ILoggerFactory LoggerFactory
@inject IRealtimeDataFactory RealtimeDataFactory

<LoadingContentView IsLoading="State != RealtimeDataState.Connected" LoadingText="Connecting to health hub...">
    <MudPaper>
        <MudText Class="health-status">@LatestHealth?.Status</MudText>
        
        @foreach (var check in HealthChecks)
        {
            <HealthStatusCheckView Check="check" />
        }
    </MudPaper>
</LoadingContentView>

@code {
    private RealtimeDataState State => Subscriber?.State ?? RealtimeDataState.Disconnected;
    
    private IRealtimeDataSubscriber? Subscriber { get; set; }
    
    private HausHealthReportModel? LatestHealth { get; set; }

    private HausHealthCheckModel[] HealthChecks => LatestHealth?.Checks ?? [];
    
    protected override async Task OnInitializedAsync()
    {
        var logger = LoggerFactory.CreateLogger("health");
        Subscriber = await RealtimeDataFactory.CreateSubscriber(HausRealtimeSources.Health);
        Subscriber.Subscribe<HausHealthReportModel>("OnHealth", async report =>
        {
            logger.LogInformation("received health report: {@Report}", report);
            await InvokeAsync(() =>
            {
                LatestHealth = report;
                StateHasChanged();
            });
        });
        await Subscriber.StartAsync();
    }

    public async ValueTask DisposeAsync()
    {
        if (Subscriber != null)
        {
            await Subscriber.DisposeAsync();
        }
    }

}